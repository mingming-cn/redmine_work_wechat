<% if RedmineWorkWechat.enabled? && RedmineWorkWechat.open_in_default_browser? %>
  <script>
      let ua = navigator.userAgent.toLowerCase();
      if (ua.match(/WxWork/i).toString() === "wxwork") {
          url = window.location.href.split('#')[0];
          fetch("/work_wechat/js_sdk_config?page_url=" + url)
              .then((response) => response.json())
              .then((data) => {
                  if (data.err) {
                      alert(data.err)
                      return
                  }
                  ww.register({
                      corpId: "<%= RedmineWorkWechat.corpid %>",
                      agentId: "<%= RedmineWorkWechat.agentid %>",
                      jsApiList: ['openDefaultBrowser'],
                      getConfigSignature
                  })

                  async function getConfigSignature() {
                      return {
                          timestamp: data.timestamp,
                          nonceStr: data.noncestr,
                          signature: data.signature
                      }
                  }

                  ww.openDefaultBrowser({
                      url: url,
                      fail(result) {
                          alert(JSON.stringify(result))
                      },
                  })

              })
              .catch((error) => alert(error));
      }
  </script>
<% end %>
